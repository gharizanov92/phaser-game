<!DOCTYPE html>
<html>
<head>
	<title>Game</title>
</head>
<body>
	<div id="game"></div>
	<script type="text/javascript" src="js/phaser.min.js"></script>
	<script type="text/javascript" src="js/easystar-0.3.0.min.js"></script>
	<script type="text/javascript" src="js/phaser_pathfinding-0.2.0.min.js"></script>
	<script type="text/javascript" src="js/utils.js"></script>
	<script type="text/javascript" src="js/tanks.js"></script>
	<script type="text/javascript">
		var game = new Phaser.Game(800, 480, Phaser.AUTO, 'game', { preload: preload, create: create, update: update });

		function preload() {
			game.load.image('cup', 'assets/cup.png');
			game.load.image('goblein', 'assets/goblein.jpg');
		    game.load.spritesheet('lady gaga', 'assets/stella_walk.png', 64, 64);
		    game.load.image('star', 'assets/diamond.png');
		    game.load.image('waypoint', 'assets/waypoint.png');
		    game.load.image('grass', 'assets/grass_random_grid.png');
		    game.load.tilemap('map', 'assets/map.json', null, Phaser.Tilemap.TILED_JSON);
		    game.load.image('tiles', 'assets/ground_tiles.png', 64, 64);
		    game.load.spritesheet('background', 'assets/ground_tiles.png', 64, 64);

			game.load.atlas('enemy', 'assets/tanks/enemy-tanks.png', 'assets/tanks/tanks.json');
			game.load.image('enemy-turret', 'assets/tanks/turret.png');
			game.load.image('bullet', 'assets/tanks/bullet.png');
			game.load.spritesheet('kaboom', 'assets/tanks/explosion.png', 64, 64, 23);
		}

		var TILE_WIDTH = 32;
		var TILE_HEIGHT = 32;

		var player;
		var platforms;
		var cursors;

		var goblein;

		var moveToX = 300;
		var moveToY = 200;

		var tileWidth = 10;
		var tileHeight = 10;

		var map;
		var tileset;
		var grid;
		var layer;
		var pathfinder;
		var path;
		var direction;

		var stars;
		var waypoints;
		var obstacles;
		var score = 0;
		var scoreText;

		var enemies;
		var enemyBullets;
		var enemiesTotal = 0;
		var enemiesAlive = 0;
		var explosions;

		var nextTankSpawn = 5000;
		var tankRespawnRate = 5000;

		var nextFire = 0;
		var fireRate = 500;
		var canShoot = false;

		var bullets;
		var graphics;
		var arrow;

		var animationAngles = {
			0: 'right',
			45: 'upRight',
			90: 'up',
			135: 'upLeft',
			180: 'left',
			225: 'downLeft',
			270: 'down',
			315: 'downRight'
		};

		function create() {	

			game.scale.fullScreenScaleMode = Phaser.ScaleManager.SHOW_ALL;

			// game
			game.world.setBounds(0, 0, 800, 480);

			graphics = game.add.graphics(0, 0);		   
			graphics.lineStyle(2, 0x0000FF, 0.5);
    		graphics.drawRect(0, 0, 100, 5);

		    map = game.add.tilemap('map');
    		map.addTilesetImage('ground_tiles', 'tiles');
		    layer = map.createLayer('walkable');
		    obsticles = map.createLayer('obsticles');

			// room
			game.physics.startSystem(Phaser.Physics.ARCADE);
		    platforms = game.add.group();
		    platforms.enableBody = true;

		    var walkables = [0, 22, 23, 24, 25, 26, 19, 13, 14, 7, 8, 9, 10, 11, 12, 20, 21];
		    //var walkables = [127];

		    pathfinder = game.plugins.add(Phaser.Plugin.PathFinderPlugin);
		    pathfinder._easyStar.enableDiagonals();
		    pathfinder.setGrid(map.layers[0].data, walkables);

	    	// stars
		    stars = game.add.group();
		    stars.enableBody = true;
		    stars.create(250, 210, 'star');

		    waypoints = game.add.group();
		    waypoints.enableBody = true;

		    // obstacles
		    obstacles = game.add.group();
		    obstacles.enableBody = true;

			//obstacles.body.immovable = true;
			goblein = game.add.sprite(364, 220, 'cup');
			goblein = game.add.sprite(364, 220, 'goblein');

		    // player
		    player = game.add.sprite(300, 200, 'lady gaga');
		    player.anchor.setTo(0.5, 0.5);
			player.scale.setTo(0.75, 0.75);

		    //  We need to enable physics on the player
		    game.physics.arcade.enable(player);
		    player.body.collideWorldBounds = true;

		    //  Our two animations, walking left and right.
		    player.animations.add('down', [0, 1, 2, 3], 8, true);
		    player.animations.add('left', [4, 5, 6, 7], 8, true);
		    player.animations.add('right', [8, 9, 10, 11], 8, true);
		    player.animations.add('up', [12, 13, 14, 15], 8, true);
		    player.animations.add('downRight', [16, 17, 18, 19], 8, true);
		    player.animations.add('downLeft', [20, 21, 22, 23], 8, true);
		    player.animations.add('upLeft', [24, 25, 26, 27], 8, true);
		    player.animations.add('upRight', [28, 29, 30, 31], 8, true);

		    cursors = game.input.keyboard.createCursorKeys();

			// enemies
			//  The enemies bullet group
			enemyBullets = game.add.group();
			enemyBullets.enableBody = true;
			enemyBullets.physicsBodyType = Phaser.Physics.ARCADE;
			enemyBullets.createMultiple(100, 'bullet');

			enemyBullets.setAll('anchor.x', 0.5);
			enemyBullets.setAll('anchor.y', 0.5);
			enemyBullets.setAll('outOfBoundsKill', true);
			enemyBullets.setAll('checkWorldBounds', true);
			//enemyBullets.setAll('scale', (0.5, 0.5));
			//bullet.scale.set(0.5, 0.5);

			enemies = [];

			enemiesTotal = 1;
			enemiesAlive = 1;

			for (var i = 0; i < enemiesTotal; i++) {
				enemies.push(new EnemyTank(i, game, player, goblein, enemyBullets, pathfinder));
			}

			//  Our bullet group
			bullets = game.add.group();
			bullets.enableBody = true;
			bullets.physicsBodyType = Phaser.Physics.ARCADE;
			bullets.createMultiple(30, 'bullet', 0, false);
			bullets.setAll('anchor.x', 0.5);
			bullets.setAll('anchor.y', 0.5);
			bullets.setAll('outOfBoundsKill', true);
			bullets.setAll('checkWorldBounds', true);

			//  Explosion pool
			explosions = game.add.group();

			for (var i = 0; i < 300; i++)
			{
				var explosionAnimation = explosions.create(0, 0, 'kaboom', [0], false);
				explosionAnimation.anchor.setTo(0.5, 0.5);
				explosionAnimation.animations.add('kaboom');
			}

			game.input.onDown.add(moveTo);

			game.input.onUp.add(function() {
				if (canShoot && game.time.now > nextFire) {
					nextFire = game.time.now + fireRate;
					var bullet = this.bullets.getFirstDead();
	            	bullet.reset(player.x, player.y);
	            	bullet.rotation = game.physics.arcade.moveToPointer(bullet, 400);
				}
				canShoot = false;
				//arrow.visible = false;
				arrow.kill();
			});

			arrow = game.add.sprite(player.x, player.y, graphics.generateTexture());
			arrow.kill();
		}

		function update() {

			player.body.velocity.x = 0;
			player.body.velocity.y = 0;

			game.world.bringToTop(explosions);

		    game.physics.arcade.collide(player, platforms);
			game.physics.arcade.collide(stars, platforms);
			game.physics.arcade.collide(player, obsticles);
			game.physics.arcade.overlap(player, stars, collectStar, null, this);

			game.physics.arcade.overlap(enemyBullets, player, bulletHitPlayer, null, this);

			// show player movement
			game.physics.arcade.overlap(enemies, waypoints, function(player, waypoint){
				if (!waypoint.markedForKill) {
					setTimeout(function() {
						waypoint.kill();
					}, 50);
				}
				waypoint.markedForKill = true;
			}, null, this);

			// if we've reached the next point
	    	if (game.physics.arcade.distanceBetween(player, new Phaser.Point(moveToX, moveToY)) > 3) {
				var from = new Phaser.Point(player.x + 5, player.y + 5);
				var to = new Phaser.Point(moveToX + 5, moveToY + 5);
				direction = game.physics.arcade.angleBetween(from, to);
				game.physics.arcade.velocityFromRotation(direction, 150, player.body.velocity);
	    	} else {
	    		player.animations.stop();
				if (path && path.length > 0) {
					var nextPoint = path[0];
					moveToX = nextPoint.x * TILE_WIDTH;
					moveToY = nextPoint.y * TILE_HEIGHT;
					path = path.slice(1);
				}
	    	}

			player.animations.play(animationAngles[radToDeg(direction)]);

			// handle enemies

			// update all enemies
			for (var i = 0; i < enemies.length; i++) {
				if (enemies[i].alive) {
					enemiesAlive++;
					game.physics.arcade.overlap(bullets, enemies[i].tank, bulletHitEnemy, null, this);
					game.physics.arcade.overlap(enemyBullets, enemies[i].tank, bulletHitEnemy, null, this);
					enemies[i].update();
				}
			}

			// spawn new onews
			if (game.time.now > nextTankSpawn) {
				nextTankSpawn = game.time.now + tankRespawnRate;
				if (tankRespawnRate > 1000) {
					tankRespawnRate -= 250;
				}
				enemies.push(new EnemyTank(enemiesTotal++, game, player, goblein, enemyBullets, pathfinder));
			}

			if (arrow && arrow.alive) {
				arrow.rotation =  game.physics.arcade.angleToPointer(player);
				arrow.x = player.x;
				arrow.y = player.y;
			}
		}

		function moveTo(tile) {
			
			if (game.physics.arcade.distanceBetween(player, game.input.activePointer) < 32) {
				canShoot = true;
				arrow = game.add.sprite(player.x + player.width / 2, player.y + player.height / 2, graphics.generateTexture());
				//arrow = game.add.sprite(player.x, player.y, graphics.generateTexture());
			} else {
				findPath(new Phaser.Point(player.x + 48, player.y + 48), new Phaser.Point(game.input.activePointer.pageX, game.input.activePointer.pageY), createPathForPlayer);
			}
		}

		function bulletHitPlayer(player, bullet) {
		    bullet.kill();
	        var xDist = 32 * Math.cos(bullet.rotation);
	        var yDist = - 32 * Math.sin(bullet.rotation);
	        createExplosionAt(bullet.x + xDist, bullet.y - yDist);
		}

		function bulletHitEnemy (tank, bullet) {

		    bullet.kill();
	        var xDist = 32 * Math.cos(bullet.rotation);
	        var yDist = - 32 * Math.sin(bullet.rotation);
	        createExplosionAt(bullet.x + xDist, bullet.y - yDist);
	        console.log(tank.name);
	        enemies[tank.name].damage();
	        enemies.forEach(function(enemy, i) {
	        	if (enemy && enemy.name == tank.name) {
					enemies[i].damage();
	        	}
	        });
		}

		function createPathForPlayer(found_path) {
			found_path = found_path || [];
			path = found_path;
			waypoints.removeAll();
			blocked = false;
			path = path.slice(1);

			for(var i = 0, ilen = path.length; i < ilen; i++) {
				if (path[i].x == 0) {
					path[i].x = 1;
				}
				if (path[i].y == 0) {
					path[i].y = 1;
				}
				waypoints.create(path[i].x * TILE_WIDTH, path[i].y * TILE_HEIGHT, 'waypoint');
			}

			moveToX = path[0].x * TILE_WIDTH;// - TILE_WIDTH;
			moveToY = path[0].y * TILE_HEIGHT;// - TILE_HEIGHT;
		}

		function collectStar (player, star) {
		    // Removes the star from the screen
		    star.kill();
		    x = Math.floor(Math.random() * (game.world.width - 32));
		    y = Math.floor(Math.random() * (game.world.height - 32));

		    stars.create(x, y, 'star');

	        score += 10;
    		//scoreText.text = 'Score: ' + score;
		}

	</script>
</body>
</html>